{% extends "base.html" %}

{% block title %}PelisMatch - Recomendaciones Inteligentes{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero">
    <div class="hero-content">
        <div class="container">
            <h1 class="fade-in-up">üé¨ PelisMatch</h1>
            <p class="lead fade-in-up">Tu asistente inteligente para <strong>encontrar la pel√≠cula perfecta</strong></p>
            <p class="text-tech fade-in-up">IA Avanzada ‚Ä¢ Recomendaciones Personalizadas ‚Ä¢ B√∫squeda Inteligente</p>
        </div>
    </div>
</div>

<!-- Opciones de B√∫squeda -->
<div class="container my-5">
    <div class="row g-4">
        <!-- B√∫squeda Simple -->
        <div class="col-md-6">
            <div class="feature-card text-center">
                <div class="feature-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h4 class="text-gradient">B√∫squeda Simple</h4>
                <p>Encuentra pel√≠culas similares usando nuestro algoritmo de grafos ponderados</p>
                
                <form id="form-busqueda-simple" class="mt-4">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="nombre-pelicula" 
                               placeholder="Ej: Matrix, Avengers, Titanic..." required>
                    </div>
                    <button type="submit" class="btn btn-gradient">
                        <i class="fas fa-project-diagram me-2"></i>Buscar Similares
                    </button>
                </form>
            </div>
        </div>

        <!-- Recomendaciones por Favoritos -->
        <div class="col-md-6">
            <div class="feature-card text-center">
                <div class="feature-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h4 class="text-gradient">IA Neural</h4>
                <p>Recomendaciones personalizadas usando redes neuronales y tus pel√≠culas favoritas</p>
                
                <div class="mt-4">
                    <p class="text-muted small">Primero agrega pel√≠culas a favoritos</p>
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                        <button class="btn btn-outline-gradient btn-sm" onclick="mostrarPeliculasCompatibles()">
                            <i class="fas fa-robot me-1"></i>Pel√≠culas IA
                        </button>
                        <button class="btn btn-outline-gradient" onclick="mostrarFavoritos()">
                            <i class="fas fa-heart me-2"></i>Ver Favoritos 
                            <span class="badge bg-pink ms-1" id="favoritos-count-main">0</span>
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-gradient" onclick="recomendarPorFavoritos()" 
                            id="btn-ia-main" disabled>
                        <i class="fas fa-brain me-2"></i>Generar con IA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Funciones Avanzadas -->
<div class="container my-5">
    <h2 class="text-center mb-5">
        <span class="text-gradient">üß† Funciones Matem√°ticas Avanzadas</span>
    </h2>
    
    <div class="row g-4">
        <!-- L√≥gica Proposicional -->
        <div class="col-md-4">
            <div class="feature-card text-center">
                <div class="feature-icon">
                    <i class="fas fa-code-branch"></i>
                </div>
                <h5 class="text-gradient">B√∫squeda Avanzada</h5>
                <p class="small">Filtra por m√∫ltiples criterios para encontrar exactamente lo que buscas</p>
                <button class="btn btn-outline-gradient btn-sm" onclick="abrirFiltrosAvanzados()">
                    <i class="fas fa-filter me-1"></i>Abrir Filtros
                </button>
            </div>
        </div>

        <!-- Chatbot FSM -->
        <div class="col-md-4">
            <div class="feature-card text-center">
                <div class="feature-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h5 class="text-gradient">Chatbot FSM</h5>
                <p class="small">Conversaci√≥n guiada con m√°quina de estados finitos</p>
                <button class="btn btn-outline-gradient btn-sm" onclick="iniciarChatbot()">
                    <i class="fas fa-comments me-1"></i>Iniciar Chat
                </button>
            </div>
        </div>

        <!-- Top N Ponderado -->
        <div class="col-md-4">
            <div class="feature-card text-center">
                <div class="feature-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h5 class="text-gradient">Top Ponderado</h5>
                <p class="small">Mejores pel√≠culas con funci√≥n de media ponderada</p>
                <a href="{{ url_for('top_movies') }}" class="btn btn-outline-gradient btn-sm">
                    <i class="fas fa-chart-line me-1"></i>Ver Ranking
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Secci√≥n de Resultados (oculta inicialmente) -->
<div class="container my-5 d-none" id="seccion-resultados">
    <div class="text-center mb-4">
        <h3 class="text-gradient">Resultados de Recomendaci√≥n</h3>
        <p id="info-busqueda" class="text-muted"></p>
    </div>
    
    <!-- Pel√≠cula Base -->
    <div class="row mb-4" id="pelicula-base" style="display: none;">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye me-2"></i>Nodo Central (Pel√≠cula Base)
                    </h5>
                </div>
                <div class="card-body" id="info-pelicula-base">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Similares -->
    <div class="row" id="lista-similares">
        <!-- Contenido din√°mico -->
    </div>
</div>

<!-- Modal de Filtros Avanzados -->
<div class="modal fade" id="filtrosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient">
                    <i class="fas fa-filter me-2"></i>B√∫squeda Avanzada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Combina m√∫ltiples criterios para encontrar pel√≠culas espec√≠ficas. <strong>Incluye</strong> lo que quieres y <strong>excluye</strong> lo que no.
                </div>
                
                <form id="form-filtros-avanzados">
                    <div class="row">
                        <!-- Incluir -->
                        <div class="col-md-6">
                            <h6 class="text-gradient">‚úÖ Quiero que tenga</h6>

                            <div class="mb-3">
                                <label class="form-label">G√©neros</label>
                                <div id="incluir-generos-list" class="row g-2">
                                    <!-- Checkboxes din√°micos -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Actores Populares</label>
                                <div id="incluir-actores-list" class="list-group" style="max-height: 180px; overflow:auto;">
                                    <!-- Lista din√°mica -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Directores Populares</label>
                                <div id="incluir-directores-list" class="list-group" style="max-height: 180px; overflow:auto;">
                                    <!-- Lista din√°mica -->
                                </div>
                            </div>
                        </div>

                        <!-- Excluir -->
                        <div class="col-md-6">
                            <h6 class="text-gradient">‚ùå No quiero que tenga</h6>

                            <div class="mb-3">
                                <label class="form-label">G√©neros</label>
                                <div id="excluir-generos-list" class="row g-2">
                                    <!-- Checkboxes din√°micos -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Actores Populares</label>
                                <div id="excluir-actores-list" class="list-group" style="max-height: 180px; overflow:auto;">
                                    <!-- Lista din√°mica -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Directores Populares</label>
                                <div id="excluir-directores-list" class="list-group" style="max-height: 180px; overflow:auto;">
                                    <!-- Lista din√°mica -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-gradient">
                            <i class="fas fa-search me-2"></i>Buscar Pel√≠culas
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Favoritos -->
<div class="modal fade" id="favoritosModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient">
                    <i class="fas fa-heart me-2"></i>Mis Pel√≠culas Favoritas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Estas pel√≠culas se usan para generar recomendaciones con IA
                    </span>
                    <div>
                        <button class="btn btn-outline-light btn-sm me-2" onclick="exportarFavoritos()">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                        <button class="btn btn-outline-light btn-sm me-2" onclick="importarFavoritos()">
                            <i class="fas fa-upload me-1"></i>Importar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="limpiarFavoritos()">
                            <i class="fas fa-trash me-1"></i>Limpiar Todo
                        </button>
                    </div>
                </div>
                
                <div class="row" id="favoritos-lista">
                    <!-- Contenido din√°mico generado por favoritos.js -->
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-gradient btn-lg" onclick="recomendarPorFavoritos()" id="btn-recomendar-favoritos">
                        <i class="fas fa-magic me-2"></i>Generar Recomendaciones IA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
<script>
// Caches de cat√°logos
let CATALOG_GENRES = [];
let CATALOG_ACTORS = [];
let CATALOG_DIRECTORS = [];

// Inicializaci√≥n de la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar contador de favoritos
    actualizarContadorFavoritos();
    
    // Event listeners
    document.getElementById('form-busqueda-simple').addEventListener('submit', buscarSimilares);
    document.getElementById('form-filtros-avanzados').addEventListener('submit', aplicarFiltrosLogicos);
    
    // Animaciones
    setTimeout(() => {
        document.querySelectorAll('.fade-in-up').forEach((el, index) => {
            setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 200);
        });
    }, 100);
});

// Funci√≥n para b√∫squeda simple
async function buscarSimilares(event) {
    event.preventDefault();
    
    const nombrePelicula = document.getElementById('nombre-pelicula').value.trim();
    if (!nombrePelicula) return;
    
    const btn = event.target.querySelector('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> Buscando...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/similares/${encodeURIComponent(nombrePelicula)}`);
        const data = await response.json();
        
        if (response.ok) {
            mostrarResultados(data, 'pel√≠culas similares');
        } else {
            mostrarError(data.error || 'Error en la b√∫squeda');
        }
    } catch (error) {
        mostrarError('Error de conexi√≥n');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Funci√≥n para mostrar resultados
function mostrarResultados(data, tipo) {
    const seccion = document.getElementById('seccion-resultados');
    const infoBusqueda = document.getElementById('info-busqueda');
    const peliculaBase = document.getElementById('pelicula-base');
    const infoPeliculaBase = document.getElementById('info-pelicula-base');
    const listaSimilares = document.getElementById('lista-similares');
    
    // Mostrar informaci√≥n del tipo de b√∫squeda
    infoBusqueda.textContent = `Resultados de ${tipo}`;
    
    // Mostrar pel√≠cula base si existe
    if (data.pelicula_buscada) {
        peliculaBase.style.display = 'block';
        infoPeliculaBase.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <img src="${data.pelicula_buscada.poster_url}" class="img-fluid rounded movie-poster" alt="${data.pelicula_buscada.nombre}">
                </div>
                <div class="col-md-9">
                    <h5 class="text-gradient">${data.pelicula_buscada.nombre}</h5>
                    <p class="text-light mb-3">${data.pelicula_buscada.overview || 'Descripci√≥n no disponible'}</p>
                    <div class="mt-3">
                        <button class="btn btn-outline-light btn-sm" onclick="agregarAFavoritos(${data.pelicula_buscada.tmdb_id}, '${data.pelicula_buscada.nombre}', '${data.pelicula_buscada.poster_url}')">
                            <i class="fas fa-heart me-2"></i>Agregar a Favoritos
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else {
        peliculaBase.style.display = 'none';
    }
    
    // Mostrar lista de similares/recomendaciones
    let similares = data.similares || data.recomendaciones || data;
    if (Array.isArray(similares)) {
        listaSimilares.innerHTML = similares.map(pelicula => `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="movie-card">
                    <img src="${pelicula.poster_url || pelicula.poster_url}" class="movie-poster" alt="${pelicula.nombre || pelicula.titulo}">
                    <div class="movie-info">
                        <h6 class="text-white mb-2">${pelicula.nombre || pelicula.titulo}</h6>
                        ${pelicula.similitud ? `<span class="similarity-score">Similitud: ${pelicula.similitud.toFixed(2)}</span>` : ''}
                        <div class="mt-2">
                            <button class="btn btn-outline-light btn-sm" onclick="agregarAFavoritos(${pelicula.tmdb_id || pelicula.tmdb_id}, '${pelicula.nombre || pelicula.titulo}', '${pelicula.poster_url}')">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        listaSimilares.innerHTML = '<div class="col-12"><p class="text-center text-muted">No se encontraron resultados.</p></div>';
    }
    
    // Mostrar secci√≥n y hacer scroll
    seccion.classList.remove('d-none');
    seccion.scrollIntoView({ behavior: 'smooth' });
}

// Funci√≥n para mostrar errores
function mostrarError(mensaje) {
    const seccion = document.getElementById('seccion-resultados');
    const listaSimilares = document.getElementById('lista-similares');
    
    document.getElementById('info-busqueda').textContent = 'Error en la b√∫squeda';
    document.getElementById('pelicula-base').style.display = 'none';
    listaSimilares.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${mensaje}
            </div>
        </div>
    `;
    
    seccion.classList.remove('d-none');
    seccion.scrollIntoView({ behavior: 'smooth' });
}

// Funci√≥n para mostrar pel√≠culas compatibles con IA
async function mostrarPeliculasCompatibles() {
    try {
        const response = await fetch('/peliculas/disponibles');
        const data = await response.json();
        
        if (response.ok) {
            // Buscar detalles de las pel√≠culas sugeridas
            const detallesPromises = data.tmdb_ids.slice(0, 6).map(async (tmdbId) => {
                try {
                    const detailResponse = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=310313c5dfcadae4d9bb178828d491a0&language=es-ES`);
                    return await detailResponse.json();
                } catch {
                    return null;
                }
            });
            
            const peliculasDetalles = await Promise.all(detallesPromises);
            const peliculasValidas = peliculasDetalles.filter(p => p);
            
            // Mostrar en la secci√≥n de resultados
            mostrarResultadosEspeciales(peliculasValidas, 'pel√≠culas compatibles con IA', 
                'Estas pel√≠culas S√ç funcionan con las recomendaciones de inteligencia artificial:');
        } else {
            mostrarError(data.error || 'Error obteniendo pel√≠culas compatibles');
        }
    } catch (error) {
        mostrarError('Error de conexi√≥n');
    }
}

// Funci√≥n para mostrar resultados especiales (pel√≠culas compatibles)
function mostrarResultadosEspeciales(peliculas, tipo, descripcion) {
    const seccion = document.getElementById('seccion-resultados');
    const infoBusqueda = document.getElementById('info-busqueda');
    const peliculaBase = document.getElementById('pelicula-base');
    const listaSimilares = document.getElementById('lista-similares');
    
    infoBusqueda.innerHTML = `
        <span class="text-gradient">${tipo}</span>
        <br><small class="text-muted">${descripcion}</small>
    `;
    peliculaBase.style.display = 'none';
    
    listaSimilares.innerHTML = peliculas.map(pelicula => `
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="movie-card">
                <img src="https://image.tmdb.org/t/p/w500${pelicula.poster_path}" class="movie-poster" alt="${pelicula.title}">
                <div class="movie-info">
                    <h6 class="text-white mb-2">${pelicula.title}</h6>
                    <small class="text-success"><i class="fas fa-robot me-1"></i>Compatible IA</small>
                    <div class="mt-2">
                        <button class="btn btn-gradient btn-sm" onclick="agregarAFavoritos(${pelicula.id}, '${pelicula.title}', 'https://image.tmdb.org/t/p/w500${pelicula.poster_path}')">
                            <i class="fas fa-heart me-1"></i>Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    seccion.classList.remove('d-none');
    seccion.scrollIntoView({ behavior: 'smooth' });
}

// Funci√≥n para abrir filtros avanzados
function abrirFiltrosAvanzados() {
    const modal = new bootstrap.Modal(document.getElementById('filtrosModal'));
    cargarCatalogosAvanzados();
    modal.show();
}

// Cargar cat√°logos para filtros (g√©neros y personas populares)
async function cargarCatalogosAvanzados() {
    try {
        // Cargar g√©neros si no est√°n
        if (CATALOG_GENRES.length === 0) {
            const resG = await fetch('/api/genres');
            const dataG = await resG.json();
            if (resG.ok) {
                CATALOG_GENRES = dataG.genres || [];
                renderCheckboxGenres('incluir-generos-list', CATALOG_GENRES, 'inc-gen');
                renderCheckboxGenres('excluir-generos-list', CATALOG_GENRES, 'exc-gen');
            }
        }

        // Cargar personas populares si no est√°n
        if (CATALOG_ACTORS.length === 0 || CATALOG_DIRECTORS.length === 0) {
            const resP = await fetch('/api/catalogo/personas');
            const dataP = await resP.json();
            if (resP.ok) {
                CATALOG_ACTORS = dataP.actores || [];
                CATALOG_DIRECTORS = dataP.directores || [];
                renderPersonList('incluir-actores-list', CATALOG_ACTORS, 'inc-act');
                renderPersonList('excluir-actores-list', CATALOG_ACTORS, 'exc-act');
                renderPersonList('incluir-directores-list', CATALOG_DIRECTORS, 'inc-dir');
                renderPersonList('excluir-directores-list', CATALOG_DIRECTORS, 'exc-dir');
            }
        }
    } catch (e) {
        console.error('Error cargando cat√°logos:', e);
    }
}

function renderCheckboxGenres(containerId, genres, prefix) {
    const cont = document.getElementById(containerId);
    if (!cont) return;
    cont.innerHTML = genres.map(g => `
        <div class="col-6 col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${g.id}" id="${prefix}-${g.id}">
                <label class="form-check-label" for="${prefix}-${g.id}">${g.name}</label>
            </div>
        </div>
    `).join('');
}

function renderPersonList(containerId, persons, prefix) {
    const cont = document.getElementById(containerId);
    if (!cont) return;
    cont.innerHTML = persons.map(p => `
        <label class="list-group-item d-flex align-items-center">
            <input class="form-check-input me-2" type="checkbox" value="${p.id}" id="${prefix}-${p.id}">
            <span>${p.nombre}</span>
        </label>
    `).join('');
}

// Funci√≥n para aplicar filtros l√≥gicos
async function aplicarFiltrosLogicos(event) {
    event.preventDefault();
    // Recolectar IDs seleccionados desde checkboxes
    const incluirGeneros = Array.from(document.querySelectorAll('#incluir-generos-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    const excluirGeneros = Array.from(document.querySelectorAll('#excluir-generos-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    const incluirActores = Array.from(document.querySelectorAll('#incluir-actores-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    const excluirActores = Array.from(document.querySelectorAll('#excluir-actores-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    const incluirDirectores = Array.from(document.querySelectorAll('#incluir-directores-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    const excluirDirectores = Array.from(document.querySelectorAll('#excluir-directores-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));

    const filtros = {
        incluir: {
            generos: incluirGeneros,
            actores: incluirActores,
            directores: incluirDirectores
        },
        excluir: {
            generos: excluirGeneros,
            actores: excluirActores,
            directores: excluirDirectores
        }
    };
    
    const btn = event.target.querySelector('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> Procesando...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/buscar/logica', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('filtrosModal')).hide();
            mostrarResultados(data, 'b√∫squeda avanzada');
        } else {
            mostrarError(data.error || 'Error en los filtros');
        }
    } catch (error) {
        mostrarError('Error de conexi√≥n');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
</script>
{% endblock %}