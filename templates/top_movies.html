{% extends "base.html" %}

{% block title %}Top Movies - PelisMatch{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="hero text-center py-5">
        <h1 class="text-gradient">üèÜ Top Movies Ponderado</h1>
        <p class="lead">Mejores pel√≠culas calculadas con <strong>Funci√≥n de Media Ponderada</strong></p>
        <div class="text-tech">
            <p>F√≥rmula: W = (v √∑ (v+m)) √ó R + (m √∑ (v+m)) √ó C</p>
            <small>Donde: v = votos, m = m√≠nimo votos, R = rating, C = promedio global</small>
        </div>
    </div>

    <!-- Controles y filtros -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Este ranking utiliza la <strong>funci√≥n de media ponderada</strong> para balancear 
                la popularidad (n√∫mero de votos) con la calidad (rating promedio).
                Las pel√≠culas con m√°s votos tienen mayor peso en el c√°lculo.
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-gradient" onclick="cargarTopPeliculas()">
                <i class="fas fa-sync-alt me-2"></i>Actualizar Ranking
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-top" class="text-center py-5" style="display: none;">
        <div class="loading mx-auto mb-3"></div>
        <p class="text-muted">Calculando rankings ponderados...</p>
    </div>

    <!-- Lista de pel√≠culas -->
    <div class="row" id="lista-top-peliculas">
        <!-- Contenido din√°mico -->
    </div>

    <!-- Explicaci√≥n matem√°tica -->
    <div class="mt-5">
        <div class="feature-card">
            <h4 class="text-gradient mb-3">
                <i class="fas fa-calculator me-2"></i>Explicaci√≥n Matem√°tica
            </h4>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>üî¢ F√≥rmula de Ponderaci√≥n</h6>
                    <div class="bg-dark p-3 rounded mb-3" style="font-family: 'JetBrains Mono';">
                        W = (v √∑ (v+m)) √ó R + (m √∑ (v+m)) √ó C
                    </div>
                    
                    <ul class="list-unstyled">
                        <li><strong>W:</strong> Puntuaci√≥n ponderada final</li>
                        <li><strong>v:</strong> N√∫mero de votos de la pel√≠cula</li>
                        <li><strong>m:</strong> M√≠nimo de votos requeridos (1000)</li>
                        <li><strong>R:</strong> Rating promedio de la pel√≠cula</li>
                        <li><strong>C:</strong> Rating promedio global (7.0)</li>
                    </ul>
                </div>
                
                <div class="col-md-6">
                    <h6>üìä ¬øPor qu√© esta f√≥rmula?</h6>
                    <ul>
                        <li>‚úÖ <strong>Previene inflaci√≥n:</strong> Una pel√≠cula con 5 votos excelentes no supera a una con 10,000 votos buenos</li>
                        <li>‚úÖ <strong>Recompensa consistencia:</strong> M√°s votos = m√°s confiabilidad</li>
                        <li>‚úÖ <strong>Equilibra calidad:</strong> No ignora pel√≠culas con pocos votos pero excelente rating</li>
                        <li>‚úÖ <strong>Matem√°ticamente s√≥lida:</strong> Basada en el algoritmo de IMDb</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cargar top pel√≠culas al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    cargarTopPeliculas();
});

// Funci√≥n para cargar las mejores pel√≠culas
async function cargarTopPeliculas() {
    const loading = document.getElementById('loading-top');
    const lista = document.getElementById('lista-top-peliculas');
    
    loading.style.display = 'block';
    lista.innerHTML = '';
    
    try {
        const response = await fetch('/api/top-peliculas');
        const data = await response.json();
        
        if (response.ok && data.peliculas) {
            mostrarTopPeliculas(data.peliculas);
        } else {
            lista.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el ranking: ${data.error || 'Error desconocido'}
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        lista.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-wifi me-2"></i>Error de conexi√≥n. Verifica tu internet.
                </div>
            </div>
        `;
    } finally {
        loading.style.display = 'none';
    }
}

// Funci√≥n para mostrar las pel√≠culas en el ranking
function mostrarTopPeliculas(peliculas) {
    const lista = document.getElementById('lista-top-peliculas');
    
    lista.innerHTML = peliculas.map((pelicula, index) => `
        <div class="col-12 mb-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Posici√≥n -->
                        <div class="col-auto">
                            <div class="rank-badge ${getRankClass(index)}">
                                ${index + 1}
                            </div>
                        </div>
                        
                        <!-- Poster -->
                        <div class="col-auto">
                            <img src="${pelicula.poster_url}" class="rounded" 
                                 style="width: 80px; height: 120px; object-fit: cover;" 
                                 alt="${pelicula.titulo}">
                        </div>
                        
                        <!-- Informaci√≥n -->
                        <div class="col">
                            <h5 class="text-white mb-2">${pelicula.titulo}</h5>
                            <p class="text-muted small mb-2">${pelicula.overview.substring(0, 150)}...</p>
                            
                            <!-- M√©tricas -->
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-gradient">
                                    <i class="fas fa-star me-1"></i>Ponderado: ${pelicula.puntuacion_ponderada}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="fas fa-thumbs-up me-1"></i>Rating: ${pelicula.rating_original}/10
                                </span>
                                <span class="badge bg-info">
                                    <i class="fas fa-users me-1"></i>Votos: ${pelicula.votos.toLocaleString()}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Acciones -->
                        <div class="col-auto">
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-outline-light btn-sm" 
                                        onclick="agregarAFavoritos(${pelicula.tmdb_id}, '${pelicula.titulo}', '${pelicula.poster_url}')"
                                        title="Agregar a favoritos">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="btn btn-outline-gradient btn-sm" 
                                        onclick="buscarSimilaresDesdeTop('${pelicula.titulo}')"
                                        title="Buscar similares">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Funci√≥n para obtener clase CSS del ranking
function getRankClass(index) {
    if (index === 0) return 'rank-gold';
    if (index === 1) return 'rank-silver';
    if (index === 2) return 'rank-bronze';
    return 'rank-normal';
}

// Funci√≥n para buscar similares desde el top
function buscarSimilaresDesdeTop(titulo) {
    // Redirigir a la p√°gina principal con el t√≠tulo
    window.location.href = `/?search=${encodeURIComponent(titulo)}`;
}

// CSS adicional para los badges de ranking
const rankingStyles = `
<style>
.rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}

.rank-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
}

.rank-silver {
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
    color: #000;
    box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4);
}

.rank-bronze {
    background: linear-gradient(135deg, #CD7F32, #B87333);
    color: white;
    box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);
}

.rank-normal {
    background: var(--gradient-primary);
    color: white;
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', rankingStyles);
</script>
{% endblock %}